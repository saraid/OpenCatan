<html>
<head>
  <style type="text/css">
    canvas { border: solid 5px black; }
  </style>
<script type="text/javascript" src="http://127.0.0.1:3000/javascripts/jquery.js"></script>
<script type="text/javascript">
var OpenCatan = function() {};
OpenCatan.Canvas = function(element, board){
  this.element   = $(element);
  this.board     = board;
  this.width     = this.element.width();
  this.height    = this.element.height();
  this.hex_width = 50;
  this.context   = this.element.get(0).getContext('2d');
  this.h_offset  = 0;
  this.v_offset  = 0;
  this.zooming   = false;

  window.open_catan = this;
  board.init_canvas(this);
  var self = this;
  this.render = function(){
    var canvas = self;
    self.board.foreach_hex(function(hex) { hex.draw(canvas); })
    for(var path_id in self.board.path){
      self.board.path[path_id].draw(self);
    }
  };

  // Stuff!
  this.pan = function(options){
    self.context.fillStyle = "white";
    self.context.fillRect(0, 0, self.width, self.height);
    if (options.horizontal) self.h_offset += parseInt(options.horizontal);
    if (options.vertical)   self.v_offset += parseInt(options.vertical);
    self.board.init_canvas(self);
    self.render();
  };
  this.zoom = function(out, amount){
    self.context.fillStyle = "white";
    self.context.fillRect(0, 0, self.width, self.height);
    self.hex_width += out ? -amount : amount;
    self.board.init_canvas(self);
    self.render();
  };
};
OpenCatan.Board = function(json) {
  var json = JSON.parse(json);

  // Accessors
  this.hex          = [];
  this.intersection = {};
  this.path         = {};

  for(var row=0;row<json.length;row++){
    this.hex[row] = [];
    for(var offset=0;offset<json[row].length;offset++){
      this.hex[row][offset] = new OpenCatan.Board.Hex(this, json[row][offset]);
    }
  }
  for (var path_id in this.path){
    var intersections = this.path[path_id].id.split('-');
    for (var i=0;i<2;i++)
      this.path[path_id].add_intersection(this.intersection[parseInt(intersections[i])]);
  }

  this.height = this.hex.length;
  this.width  = this.hex[0].length;

  var self = this;
  this.foreach_hex = function(proc) {
    for(var row=0;row<self.hex.length;row++)
      for(var offset=0;offset<self.hex[row].length;offset++)
        proc.call(self, self.hex[row][offset]);
  };

  // Initialize canvas.
  this.init_canvas = function(canvas){
    for(var row=0;row<this.hex.length;row++){
      for(var offset=0;offset<this.hex[row].length;offset++){
        self.hex[row][offset].init_canvas(canvas, row, offset);
      }
    }
    for (var path_id in self.path){
      self.path[path_id].init_canvas(canvas);
    }
  }
};
OpenCatan.Board.Hex = function(board, json){
  this.type = json.type;
  this.number = json.number;
  this.intersections = [];
  for(var i=0;i<6;i++) this.intersections[i] = new OpenCatan.Board.Intersection(board, json.intersections[i]);

  var self = this;
  this.define_vertices = function(x, y, canvas){
    var hex_width = canvas.hex_width;
    return [[x + (hex_width / 2)    , y                          ],
            [x + (3 * hex_width / 2), y                          ],
            [x + (2 * hex_width)    , y + (hex_width * 0.866)],
            [x + (3 * hex_width / 2), y + (hex_width * 1.732)],
            [x + (hex_width / 2)    , y + (hex_width * 1.732)],
            [x                      , y + (hex_width * 0.866)]];
  };
  this.init_canvas = function(canvas, row, offset){
    var this_row = canvas.board.hex[row]
    var h_mid = (this_row.length % 2 == 0) ? this_row.length / 2 : Math.floor(this_row.length / 2);
    var h_off = (this_row.length % 2 == 0) ? 0.5 : -1;
    self.draw_attributes = {
      'x': (canvas.width / 2) + canvas.hex_width                     * (h_off + (offset - h_mid) * 3)   + canvas.h_offset,
      'y': (canvas.height/ 2) + Math.floor(canvas.hex_width * 0.866) * (row - (board.height / 2) - 0.5) + canvas.v_offset
    };

    var vertices = self.define_vertices(self.draw_attributes.x, self.draw_attributes.y, canvas);
    for(var i=0;i<6;i++){
      self.intersections[i].init_canvas(vertices[i][0], vertices[i][1], canvas);
    }
  };

  this.draw = function(canvas){
    var context = canvas.context;
    var hex_width = canvas.hex_width;
    var x = self.draw_attributes.x;
    var y = self.draw_attributes.y;
    switch(self.type){
      case 'Desert':   context.fillStyle = "rgb(255, 222, 173)"; break;
      case 'Forest':   context.fillStyle = "rgb( 34, 139,  34)"; break;
      case 'Plain':    context.fillStyle = "rgb(  0, 255, 127)"; break;
      case 'Field':    context.fillStyle = "rgb(255, 223,   0)"; break;
      case 'Mountain': context.fillStyle = "rgb(112, 128, 144)"; break;
      case 'Hill':     context.fillStyle = "rgb(233, 116,  81)"; break;
      case 'Water':    context.fillStyle = "rgb(  0, 127, 255)"; break;
      case 'Mine':     context.fillStyle = "rgb( 47,  79,  79)"; break;
      default:         context.fillStyle = "rgb(255, 255, 255)"; break;
    }
    context.beginPath();
    var vertices = self.define_vertices(x, y, canvas);
    context.moveTo(vertices[0][0], vertices[0][1]);
    for (i = 0; i < 6; i++)
      context.lineTo(vertices[i][0], vertices[i][1]);
    context.fill();

    if (self.number){
      var center = { 'x': x + hex_width, 'y': y + Math.floor(0.866 * hex_width) };
      context.fillStyle = "white";
      context.beginPath();
      context.arc(center.x, center.y, 12, 0, Math.PI*2, true);
      context.fill();
      context.textAlign = "center";
      context.font = "12px Times";
      context.fillStyle = "black";
      context.fillText(self.number, center.x, center.y + 4);
    }

    for (var i=0;i<6;i++) self.intersections[i].draw(canvas);
  };
};
OpenCatan.Board.Intersection = function(board, json){
  this.id = json.id;
  this.piece = json.piece;
  board.intersection[this.id] = this;
  this.paths = []
  for(var i=0;i<json.paths.length;i++){
    if (board.path[json.paths[i].id])
      this.paths[i] = board.path[json.paths[i].id];
    else
      this.paths[i] = new OpenCatan.Board.Path(board, json.paths[i]);
  }

  var self = this;
  this.init_canvas = function(x, y, canvas){
    self.draw_attributes = { 'x': x, 'y': y };
  };

  this.invisible = false;
  this.draw = function(canvas){
    var x = self.draw_attributes.x;
    var y = self.draw_attributes.y;
    canvas.context.fillStyle = !self.invisible ? "black" : "white";
    canvas.context.beginPath();
    var size = canvas.hex_width / 8;
    if (self.invisible) size+=2;
    canvas.context.arc(x, y, size, 0, Math.PI*2, true);
    canvas.context.fill();
  };
};
OpenCatan.Board.Path = function(board, json){
  this.id = json.id;
  this.piece = json.piece
  this.intersections = [];
  board.path[this.id] = this;
  this.invisible = false;

  var self = this;
  this.add_intersection = function(intersection){
    for (var i=0;i<self.intersections.length;i++){
      if (intersection.id == self.intersections[i].id) return;
    }
    self.intersections.push(intersection);
  };
  this.init_canvas = function(canvas){
    var x = (self.intersections[0].draw_attributes.x + self.intersections[1].draw_attributes.x)/2;
    var y = (self.intersections[0].draw_attributes.y + self.intersections[1].draw_attributes.y)/2;
    var angle;
    if (self.intersections[0].draw_attributes.y == self.intersections[1].draw_attributes.y)
      angle = 0;
    else if ((self.intersections[0].draw_attributes.x - self.intersections[1].draw_attributes.x)/
             (self.intersections[0].draw_attributes.y - self.intersections[1].draw_attributes.y) > 0)
      angle = Math.PI*4/3;
    else
      angle = Math.PI*-1/3;
    self.draw_attributes = { x: x, y: y, angle: angle };
  };

  this.draw = function(canvas){
    var context = canvas.context;
    var x     = self.draw_attributes.x;
    var y     = self.draw_attributes.y;
    var angle = self.draw_attributes.angle;
    context.fillStyle = !self.invisible ? "black" : "white";
    var path_width  = canvas.hex_width / 10;
    var path_length = canvas.hex_width * 0.75;
    if (self.invisible) {
       path_width  += 2;
       path_length += 2;
    }

    context.save();
    context.translate(x, y);
    context.rotate(angle);
    context.beginPath();
    context.moveTo(-path_length/2, -path_width/2);
    context.lineTo( path_length/2, -path_width/2);
    context.lineTo( path_length/2,  path_width/2);
    context.lineTo(-path_length/2,  path_width/2);
    context.fill();
    context.restore();
  };
};
</script>
<script type="text/javascript" src="sample.js"></script>
<script type="text/javascript">
$(function(){
  var canvas = new OpenCatan.Canvas("#board", board);
});
</script>
</head>
<body>
  <canvas id="board" width="750" height="500"></canvas>
</body>
</html>
