<html>
<head>
<title>OpenCatan: Board size <%= params[:id] %></title>
<style type="text/css">
  canvas { 
    border: solid 10px black; 
    float: left;
  }
  div#buttons {
    float: left;
  }
</style>
<script type="text/javascript" src="/javascripts/jquery.js"></script>
<script type="text/javascript" src="/javascripts/board.js?<%= rand(100000) %>"></script>
<script type="text/javascript">
  $(document).ready(function() {
    <% 
      vertical_padding = 50 
      hex_size = (params[:hex_size] || 40).to_i
      canvas_width = hex_size*4*(@board.hex_store.rows.max { |a,b| a.length <=> b.length }.length) - hex_size
      x_offset = hex_size * 3 / 2
      canvas_height = (vertical_padding * 2) + (hex_size * 1.732).floor*((@board.hex_store.rows.length + 1) / 2)
    -%>
    <% @board.hex_store.rows.each_with_index do |row, row_index| 
         row.each_with_index do |hex, offset| 
          x = (canvas_width / 2) - (x_offset * row.length) + (x_offset * offset * 2) + hex_size / 2
          y = vertical_padding + (hex_size * 0.866).floor * row_index
    -%>
    Catan.State.add_hex(<%= x %>, <%= y %>, [<%= Catan::HEX_TYPES[hex.type][:color].join(',') %>],
                        <%= hex.number %>, "<%= hex.type %>",
                        <%= hex.row %>, <%= hex.offset %>);
    <%   end
       end 
    -%>
    <% 
        offset = 0
        rows = @board.intersection_array
        row = 0
        rows.collect! { |length| Array.new(length/2, 0) }
        rows.each_with_index do |rowN, row_index|
          push = row_index % 2 == 0 ? 1 : 2
          step = 0
          rowN.reverse.each_with_index do |num, index|
            rowN[rowN.length-index-1] = push
            step = index % 2 == 0 ? 2 : 4 if row_index % 2 == 1
            step = index % 2 == 1 ? 2 : 4 if row_index % 2 == 0
            push += step
          end
          rows[row_index] = rowN + rowN.reverse
        end
        @board.intersections.each do |intersection|
          y = vertical_padding + (hex_size * 0.866).floor*intersection.row
          x = (canvas_width / 2)

          op = offset < rows[row].length/2 ? :'-' : :'+'
          x = x.send(op, hex_size * rows[row][offset] / 2)
    -%>
    Catan.State.add_intersection(<%= intersection.identifier %>, <%= x %>, <%= y %>,
                                 [<%= intersection.hexes.collect { |hex| "[#{hex.row},#{hex.offset}]" }.join(',') %>]);
    <%    offset += 1
          if offset == rows[row].length
            row += 1
            offset = 0
          end
        end -%>
    Catan.Draw.loop = function() {
      Catan.State.draw();
    };
    Catan.Draw.init(<%= hex_size %>, { top: <%= vertical_padding %>, left: <%= x_offset %> });
  });
</script>
</head>
<body>
<canvas id="board" width="<%= canvas_width %>" height="<%= canvas_height %>"></canvas>
</body>
</html>
